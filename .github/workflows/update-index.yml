name: Mise Ã  jour automatique de index.txt

on:
  push:
    branches:
      - main
    paths:
      - 'ps/**'  # ExÃ©cuter seulement si un fichier dans ps/ est modifiÃ©

permissions:  
  contents: write  # ðŸ”¥ Donne les permissions d'Ã©criture au GITHUB_TOKEN

jobs:
  update-index:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›  RÃ©cupÃ©rer le repo
        uses: actions/checkout@v3
        with:
          persist-credentials: false  # DÃ©sactive les credentials par dÃ©faut

      - name: ðŸ”„ GÃ©nÃ©rer la liste des scripts PowerShell avec description
        run: |
          echo "" > ps/index.txt
          find ps -type f -name "*.ps1" | while read script; do
            description=$(grep -m 1 "# DESCRIPTION:" "$script" | sed 's/# DESCRIPTION: //')
            if [ -z "$description" ]; then
              description="Aucune description disponible"
            fi
            echo "$(echo "$script" | sed 's|ps/||')|$description" >> ps/index.txt
          done

      - name: ðŸ’¾ Commit et push des changements
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Utilise le token sÃ©curisÃ©
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ps/index.txt
          git commit -m "ðŸ”„ Mise Ã  jour automatique de index.txt" || exit 0
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
